SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


ALTER PROCEDURE [dbo].[cy_GroupPosts_SelectByTopic]

/*
Author:				Joe Audette
Created:			2004-09-14
Last Modified:		2008-02-15



*/

@TopicID			int,
@PageNumber			int

AS

DECLARE @PostsPerPage	int

DECLARE @CurrentPageMaxTopicSequence	int

DECLARE @BeginSequence int
DECLARE @EndSequence int



SELECT	@PostsPerPage = f.PostsPerPage


FROM		cy_GroupTopics ft

JOIN		cy_Groups f
ON		ft.GroupID = f.ItemID

WHERE	ft.TopicID = @TopicID

SET @CurrentPageMaxTopicSequence = (@PostsPerPage * @PageNumber) 
IF @CurrentPageMaxTopicSequence > @PostsPerPage
	BEGIN
		SET @BeginSequence = @CurrentPageMaxTopicSequence  - @PostsPerPage + 1
	END
ELSE
	BEGIN
		SET @BeginSequence = 1
	END

SET @EndSequence = @BeginSequence + @PostsPerPage  -1



SELECT	p.*,
		ft.GroupID,
		'MostRecentPostUser' = COALESCE(u.[Name],'Guest'),
		'StartedBy' = COALESCE(s.[Name],'Guest'),
		'PostAuthor' = COALESCE(up.[Name], 'Guest'),
		'AuthorEmail' = COALESCE(up.[Email], ''),
		'PostAuthorTotalPosts' = COALESCE(up.TotalPosts, 0),
		'UserRevenue' = COALESCE(up.TotalRevenue, 0),
		'Trusted' = COALESCE(up.Trusted, 0),
		'PostAuthorAvatar' = up.AvatarUrl,
		'PostAuthorWebSiteUrl' = up.WebSiteURL,
		'PostAuthorSignature' = up.Signature


FROM		cy_GroupPosts p

JOIN		cy_GroupTopics ft
ON		p.TopicID = ft.TopicID

LEFT OUTER JOIN		cy_Users u
ON		ft.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		cy_Users s
ON		ft.StartedByUserID = s.UserID

LEFT OUTER JOIN		cy_Users up
ON		up.UserID = p.UserID

WHERE	ft.TopicID = @TopicID
		AND p.TopicSequence >= @BeginSequence
		AND  p.TopicSequence <= @EndSequence

ORDER BY	p.SortOrder, p.PostID

GO


SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO



ALTER PROCEDURE [dbo].[cy_GroupPosts_SelectAllByTopicRevereSorted]

/*
Author:				Joe Audette
Created:			2007-07-17
Last Modified:		2009-02-15

*/

@TopicID			int


AS


SELECT	p.*,
		ft.GroupID,
		'MostRecentPostUser' = COALESCE(u.[Name],'Guest'),
		'StartedBy' = COALESCE(s.[Name],'Guest'),
		'PostAuthor' = COALESCE(up.[Name], 'Guest'),
		'AuthorEmail' = COALESCE(up.[Email], ''),
		'PostAuthorTotalPosts' = COALESCE(up.TotalPosts, 0),
		'UserRevenue' = COALESCE(up.TotalRevenue, 0),
		'Trusted' = COALESCE(up.Trusted, 0),
		'PostAuthorAvatar' = up.AvatarUrl,
		'PostAuthorWebSiteUrl' = up.WebSiteURL,
		'PostAuthorSignature' = up.Signature


FROM		cy_GroupPosts p

JOIN		cy_GroupTopics ft
ON		p.TopicID = ft.TopicID

LEFT OUTER JOIN		cy_Users u
ON		ft.MostRecentPostUserID = u.UserID

LEFT OUTER JOIN		cy_Users s
ON		ft.StartedByUserID = s.UserID

LEFT OUTER JOIN		cy_Users up
ON		up.UserID = p.UserID

WHERE	ft.TopicID = @TopicID
		

ORDER BY	p.TopicSequence DESC 


GO



